<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Excel-like Simulator (1200x675 + Formules)</title>

  <!-- HyperFormula (moteur de calcul) -->
  <script src="https://cdn.jsdelivr.net/npm/hyperformula@2.7.1/dist/hyperformula.full.min.js"></script>

  <style>
    :root{
      --W:1200;
      --H:675;

      --ui:#f3f4f6;
      --ui2:#e5e7eb;
      --line:#d1d5db;
      --text:#111827;
      --muted:#6b7280;
      --accent:#1d4ed8;

      --cellW:110px;
      --cellH:28px;
      --rowHeaderW:52px;
      --colHeaderH:26px;

      --font: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
    }

    html,body{height:100%;margin:0;background:#0000;font-family:var(--font);}

    .stage{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      background:transparent;
      overflow:hidden;
    }

    .canvas{
      width:calc(var(--W) * 1px);
      height:calc(var(--H) * 1px);
      background:white;
      box-shadow:0 18px 50px rgba(0,0,0,.18);
      border-radius:14px;
      overflow:hidden;
      transform-origin:center center;
    }

    .topbar{
      height:54px;
      background:linear-gradient(180deg, var(--ui), #ffffff);
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      gap:12px;
      padding:8px 12px;
    }
    .badge{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:10px;
      background:#ffffff;border:1px solid var(--ui2);
      font-weight:700;color:var(--text);
    }
    .badge .dot{
      width:10px;height:10px;border-radius:999px;background:var(--accent);
      box-shadow:0 0 0 3px rgba(29,78,216,.15);
    }
    .tabsRibbon{display:flex;gap:12px;color:var(--muted);font-weight:600;font-size:13px}
    .tabsRibbon .active{color:var(--text);position:relative}
    .tabsRibbon .active:after{
      content:"";position:absolute;left:0;right:0;bottom:-10px;height:3px;border-radius:99px;background:var(--accent);
    }
    .spacer{flex:1}
    .btn{
      border:1px solid var(--ui2);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      color:var(--text);
    }
    .btn.primary{border-color:rgba(29,78,216,.35); background:rgba(29,78,216,.08); color:#0b2a7a}

    .fxbar{
      height:46px;
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 12px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .nameBox{
      width:92px;
      height:34px;
      border:1px solid var(--line);
      border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      font-weight:800;
      color:#0b2a7a;
      background:#f8fafc;
      user-select:none;
    }
    .fx{
      width:30px;height:34px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid var(--line);
      background:#f8fafc;
      color:var(--muted);
      font-weight:900;
      user-select:none;
    }
    .fxInput{
      flex:1;
      height:34px;
      border:1px solid var(--line);
      border-radius:10px;
      padding:0 10px;
      outline:none;
      font-size:13px;
      color:var(--text);
      background:#fff;
    }
    .status{
      min-width:260px;
      font-size:13px;
      color:var(--muted);
      text-align:right;
      user-select:none;
    }
    .status.ok{color:#16a34a;font-weight:700}
    .status.bad{color:#dc2626;font-weight:700}

    .sheetWrap{
      height:calc(var(--H) * 1px - 54px - 46px - 44px);
      background:#fff;
      position:relative;
    }

    .work{
      position:absolute;inset:0;
      overflow:auto;
      background:#fff;
    }

    .grid{
      position:relative;
      width: calc(var(--rowHeaderW) + var(--cols) * var(--cellW));
      height: calc(var(--colHeaderH) + var(--rows) * var(--cellH));
    }

    .corner{
      position:sticky;top:0;left:0;z-index:5;
      width:var(--rowHeaderW);
      height:var(--colHeaderH);
      background:var(--ui);
      border-right:1px solid var(--line);
      border-bottom:1px solid var(--line);
    }

    .colHeader{
      position:sticky;top:0;left:var(--rowHeaderW);z-index:4;
      display:flex;
      height:var(--colHeaderH);
      background:var(--ui);
      border-bottom:1px solid var(--line);
    }
    .colHeader .h{
      width:var(--cellW);
      height:var(--colHeaderH);
      display:flex;align-items:center;justify-content:center;
      border-right:1px solid var(--line);
      font-size:12px;
      font-weight:800;
      color:#374151;
      user-select:none;
    }

    .rowHeader{
      position:sticky;left:0;top:var(--colHeaderH);z-index:3;
      width:var(--rowHeaderW);
      background:var(--ui);
      border-right:1px solid var(--line);
    }
    .rowHeader .r{
      height:var(--cellH);
      display:flex;align-items:center;justify-content:center;
      border-bottom:1px solid var(--line);
      font-size:12px;
      font-weight:800;
      color:#374151;
      user-select:none;
    }

    .cells{
      position:absolute;
      left:var(--rowHeaderW);
      top:var(--colHeaderH);
      display:grid;
      grid-template-columns: repeat(var(--cols), var(--cellW));
      grid-auto-rows: var(--cellH);
      border-top:1px solid var(--line);
      border-left:1px solid var(--line);
      background:#fff;
    }

    .cell{
      box-sizing:border-box;
      border-right:1px solid var(--line);
      border-bottom:1px solid var(--line);
      padding:5px 8px;
      font-size:13px;
      color:var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      user-select:none;
      cursor:cell;
    }

    .cell.selected{
      outline:2px solid var(--accent);
      outline-offset:-2px;
      background:rgba(29,78,216,.06);
    }

    .editBox{
      position:absolute;
      z-index:10;
      display:none;
    }
    .editInput{
      width:100%;
      height:100%;
      border:2px solid var(--accent);
      border-radius:0;
      box-sizing:border-box;
      padding:4px 7px;
      font-size:13px;
      outline:none;
      background:#fff;
      color:var(--text);
    }

    .bottomTabs{
      height:44px;
      background:var(--ui);
      border-top:1px solid var(--line);
      display:flex;
      align-items:center;
      gap:8px;
      padding:0 10px;
    }
    .sheetTab{
      cursor:pointer;
      padding:9px 12px;
      border-radius:10px;
      border:1px solid transparent;
      font-weight:800;
      font-size:13px;
      color:#374151;
      user-select:none;
    }
    .sheetTab.active{
      background:#fff;
      border-color:var(--ui2);
      color:#0b2a7a;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <div class="canvas" id="canvas">
      <div class="topbar">
        <div class="badge"><span class="dot"></span>Excel — Simulation</div>
        <div class="tabsRibbon">
          <div class="active">Accueil</div>
          <div>Insertion</div>
          <div>Formules</div>
          <div>Données</div>
        </div>
        <div class="spacer"></div>
        <button class="btn" id="prefillBtn">Exemples</button>
        <button class="btn" id="clearBtn">Réinitialiser</button>
      </div>

      <div class="fxbar">
        <div class="nameBox" id="nameBox">A1</div>
        <div class="fx">fx</div>
        <input class="fxInput" id="fxInput" placeholder='Tape une valeur ou une formule (ex: =SI(NBCAR(A2)>3;"OK";"NON"))' />
        <div class="status" id="status">Clique une cellule puis tape.</div>
      </div>

      <div class="sheetWrap">
        <div class="work" id="work">
          <div class="grid" id="grid">
            <div class="corner"></div>
            <div class="colHeader" id="colHeader"></div>
            <div class="rowHeader" id="rowHeader"></div>
            <div class="cells" id="cells"></div>

            <div class="editBox" id="editBox">
              <input class="editInput" id="editInput" />
            </div>
          </div>
        </div>
      </div>

      <div class="bottomTabs" id="tabs"></div>
    </div>
  </div>

<script>
(() => {
  /* ====== CONFIG ====== */
  const ROWS = 24;
  const COLS = 14;

  const cellW = 110, cellH = 28, rowHeaderW = 52, colHeaderH = 26;

  /* ====== SHEETS + RAW INPUT (FR) ======
     On stocke toujours ce que l'utilisateur a tapé (FR) dans raw.
     On envoie au moteur HyperFormula une version "EN" (traduite) si c'est une formule. */
  const sheets = [
    { name: "Feuil1", raw: new Map() },
    { name: "Exercices", raw: new Map() },
    { name: "Résultats", raw: new Map() },
  ];

  let activeSheet = 0;
  let selected = { r: 1, c: 1 };

  /* ====== DOM ====== */
  const el = (id) => document.getElementById(id);
  const canvas = el("canvas");
  const stage  = el("stage");
  const gridEl = el("grid");
  const workEl = el("work");
  const colHeaderEl = el("colHeader");
  const rowHeaderEl = el("rowHeader");
  const cellsEl = el("cells");
  const tabsEl = el("tabs");
  const nameBox = el("nameBox");
  const fxInput = el("fxInput");
  const status = el("status");
  const editBox = el("editBox");
  const editInput = el("editInput");

document.documentElement.style.setProperty("--rows", ROWS);
document.documentElement.style.setProperty("--cols", COLS);

  /* ====== UTILS ====== */
  const colName = (n) => {
    let s = "";
    while (n > 0) {
      const m = (n - 1) % 26;
      s = String.fromCharCode(65 + m) + s;
      n = Math.floor((n - 1) / 26);
    }
    return s;
  };
  const addr = (r, c) => `${colName(c)}${r}`;
  const key  = (r, c) => `${r},${c}`;

  function setStatus(text, type=""){
    status.textContent = text || "";
    status.className = "status" + (type ? " " + type : "");
  }

  function getRaw(r,c){
    return sheets[activeSheet].raw.get(key(r,c)) ?? "";
  }
  function setRaw(r,c,v){
    const val = (v ?? "");
    if(val === "") sheets[activeSheet].raw.delete(key(r,c));
    else sheets[activeSheet].raw.set(key(r,c), val);
  }

  /* ====== FR -> EN FORMULA TRANSLATION ======
     - Remplace séparateur d'arguments ; -> ,
     - Remplace fonctions FR -> EN
     - Garde les guillemets "..." tels quels
  */
  function frToEnFormula(fr){
    // Si ce n'est pas une formule, on renvoie tel quel
    if(!fr || fr[0] !== "=") return fr;

    // Remplacer ; par , (Excel FR) hors guillemets
    let out = "";
    let inQuotes = false;
    for(let i=0;i<fr.length;i++){
      const ch = fr[i];
      if(ch === '"') inQuotes = !inQuotes;
      if(!inQuotes && ch === ';') out += ',';
      else out += ch;
    }

    // Map fonctions (A + C)
    const fnMap = [
      ["GAUCHE", "LEFT"],
      ["DROITE", "RIGHT"],
      ["STXT", "MID"],
      ["CONCATENER", "CONCATENATE"],
      ["NBCAR", "LEN"],
      ["SI", "IF"],
      ["ET", "AND"],
      ["OU", "OR"],
      ["RECHERCHEV", "VLOOKUP"],
      ["NB.SI", "COUNTIF"],
    ];

    // Remplacer uniquement les noms de fonction suivis d'une parenthèse (évite de toucher du texte)
    for(const [frName, enName] of fnMap){
      const re = new RegExp(`\\b${frName}\\s*\\(`, "gi");
      out = out.replace(re, `${enName}(`);
    }

    return out;
  }

  /* ====== CALC ENGINE (HyperFormula) ====== */
  if(!window.HyperFormula){
    setStatus("Erreur: HyperFormula non chargé (CDN bloqué).", "bad");
    return;
  }

  // On crée un moteur avec 3 feuilles
  const hf = HyperFormula.buildEmpty({
    licenseKey: "gpl-v3", // usage open-source
  });

  const sheetIds = sheets.map(s => hf.addSheet(s.name));
  // Préparer une grille vide (ROWS x COLS) dans chaque feuille
  for(const sid of sheetIds){
    const empty = Array.from({length: ROWS}, () => Array.from({length: COLS}, () => null));
    hf.setSheetContent(sid, empty);
  }

  function engineSetCell(r,c,rawValue){
    const sid = sheetIds[activeSheet];
    const row0 = r-1, col0 = c-1;

    // Stocker ce que l'utilisateur a tapé
    setRaw(r,c,rawValue);

    // Envoyer au moteur
    if(rawValue && rawValue[0] === "="){
      const en = frToEnFormula(rawValue);
      hf.setCellContents({ sheet: sid, row: row0, col: col0 }, en);
    } else {
      // nombre vs texte
      const trimmed = (rawValue ?? "").trim();
      const asNumber = trimmed !== "" && !Number.isNaN(Number(trimmed)) ? Number(trimmed) : rawValue;
      hf.setCellContents({ sheet: sid, row: row0, col: col0 }, asNumber === "" ? null : asNumber);
    }
  }

  function engineGetDisplay(r,c){
    const sid = sheetIds[activeSheet];
    const v = hf.getCellValue({ sheet: sid, row: r-1, col: c-1 });

    // Gestion erreurs HyperFormula
    if(v && typeof v === "object" && v.value != null && v.type){
      // parfois erreurs sous forme d'objet
      return String(v.value);
    }
    if(typeof v === "string" || typeof v === "number" || typeof v === "boolean"){
      return String(v);
    }
    if(v === null || v === undefined) return "";
    return String(v);
  }

  /* ====== RENDER ====== */
  function renderHeaders(){
    colHeaderEl.innerHTML = "";
    for(let c=1;c<=COLS;c++){
      const d=document.createElement("div");
      d.className="h";
      d.textContent=colName(c);
      colHeaderEl.appendChild(d);
    }
    rowHeaderEl.innerHTML = "";
    for(let r=1;r<=ROWS;r++){
      const d=document.createElement("div");
      d.className="r";
      d.textContent=r;
      rowHeaderEl.appendChild(d);
    }
  }

  function renderTabs(){
    tabsEl.innerHTML = "";
    sheets.forEach((s, i) => {
      const t = document.createElement("div");
      t.className = "sheetTab" + (i===activeSheet ? " active" : "");
      t.textContent = s.name;
      t.onclick = () => { activeSheet=i; hideEditor(true); renderAll(); };
      tabsEl.appendChild(t);
    });
  }

  function renderCells(){
    cellsEl.innerHTML = "";
    for(let r=1;r<=ROWS;r++){
      for(let c=1;c<=COLS;c++){
        const d = document.createElement("div");
        d.className = "cell";
        d.textContent = engineGetDisplay(r,c);
        d.dataset.r = r;
        d.dataset.c = c;
        d.addEventListener("mousedown", (e) => {
          e.preventDefault();
          select(r,c);
        });
        d.addEventListener("dblclick", () => beginEdit(r,c));
        cellsEl.appendChild(d);
      }
    }
  }

  function updateSelectionUI(){
    const nodes = cellsEl.querySelectorAll(".cell");
    nodes.forEach(n => n.classList.remove("selected"));
    const idx = (selected.r-1)*COLS + (selected.c-1);
    const node = nodes[idx];
    if(node) node.classList.add("selected");

    nameBox.textContent = addr(selected.r, selected.c);
    fxInput.value = getRaw(selected.r, selected.c) || engineGetDisplay(selected.r, selected.c);
  }

  function refreshCell(r,c){
    const idx = (r-1)*COLS + (c-1);
    const node = cellsEl.querySelectorAll(".cell")[idx];
    if(node) node.textContent = engineGetDisplay(r,c);
  }

  function refreshAllCells(){
    const nodes = cellsEl.querySelectorAll(".cell");
    let i=0;
    for(let r=1;r<=ROWS;r++){
      for(let c=1;c<=COLS;c++){
        nodes[i++].textContent = engineGetDisplay(r,c);
      }
    }
  }

  function renderAll(){
    renderTabs();
    renderHeaders();
    renderCells();
    updateSelectionUI();
    ensureSelectionVisible();
    setStatus('Formules FR actives: GAUCHE/DROITE/STXT/CONCATENER/NBCAR + SI/ET/OU/RECHERCHEV/NB.SI', "ok");
  }

  /* ====== SELECTION + VISIBILITY ====== */
  function select(r,c){
    hideEditor(true);
    selected = { r, c };
    updateSelectionUI();
    setStatus("Tape pour saisir. Entrée valide, Échap annule.", "");
  }

  function ensureSelectionVisible(){
    const x = rowHeaderW + (selected.c-1)*cellW;
    const y = colHeaderH + (selected.r-1)*cellH;
    const pad = 16;

    const viewL = workEl.scrollLeft;
    const viewT = workEl.scrollTop;
    const viewR = viewL + workEl.clientWidth;
    const viewB = viewT + workEl.clientHeight;

    const cellR = x + cellW;
    const cellB = y + cellH;

    if(x - pad < viewL) workEl.scrollLeft = Math.max(0, x - pad);
    else if(cellR + pad > viewR) workEl.scrollLeft = cellR + pad - workEl.clientWidth;

    if(y - pad < viewT) workEl.scrollTop = Math.max(0, y - pad);
    else if(cellB + pad > viewB) workEl.scrollTop = cellB + pad - workEl.clientHeight;
  }

  /* ====== EDITION DIRECTE ====== */
  function beginEdit(r=selected.r, c=selected.c){
    selected = { r, c };
    updateSelectionUI();
    positionEditor();
    editInput.value = getRaw(r,c) || "";
    editBox.style.display = "block";
    editInput.focus();
    editInput.select();
  }

  function positionEditor(){
    const left = rowHeaderW + (selected.c-1)*cellW;
    const top  = colHeaderH + (selected.r-1)*cellH;

    editBox.style.left = left + "px";
    editBox.style.top  = top  + "px";
    editBox.style.width  = cellW + "px";
    editBox.style.height = cellH + "px";
  }

  function hideEditor(commit){
    if(editBox.style.display !== "block") return;
    if(commit){
      const v = editInput.value ?? "";
      engineSetCell(selected.r, selected.c, v);
      // recalcul & refresh
      refreshAllCells();
      fxInput.value = getRaw(selected.r, selected.c) || engineGetDisplay(selected.r, selected.c);
      setStatus("Enregistré ✅", "ok");
    } else {
      setStatus("Annulé", "");
    }
    editBox.style.display = "none";
  }

  window.addEventListener("keydown", (e) => {
    const inInput = document.activeElement === fxInput || document.activeElement === editInput;
    if(inInput) return;

    if(e.key === "Enter"){ e.preventDefault(); beginEdit(); return; }

    if(e.key.startsWith("Arrow")){
      e.preventDefault();
      const {r,c} = selected;
      if(e.key==="ArrowUp")    select(Math.max(1,r-1), c);
      if(e.key==="ArrowDown")  select(Math.min(ROWS,r+1), c);
      if(e.key==="ArrowLeft")  select(r, Math.max(1,c-1));
      if(e.key==="ArrowRight") select(r, Math.min(COLS,c+1));
      return;
    }

    if(e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey){
      beginEdit();
      editInput.value = e.key;
      requestAnimationFrame(() => {
        editInput.setSelectionRange(editInput.value.length, editInput.value.length);
      });
    }
  });

  editInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){ e.preventDefault(); hideEditor(true); }
    if(e.key === "Escape"){ e.preventDefault(); hideEditor(false); }
  });

  document.addEventListener("mousedown", (e) => {
    if(editBox.style.display !== "block") return;
    const within = editBox.contains(e.target);
    if(!within) hideEditor(true);
  });

  fxInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      engineSetCell(selected.r, selected.c, fxInput.value ?? "");
      refreshAllCells();
      fxInput.value = getRaw(selected.r, selected.c) || engineGetDisplay(selected.r, selected.c);
      setStatus("Enregistré ✅", "ok");
      fxInput.blur();
    }
    if(e.key === "Escape"){
      e.preventDefault();
      fxInput.value = getRaw(selected.r, selected.c) || engineGetDisplay(selected.r, selected.c);
      setStatus("Annulé", "");
      fxInput.blur();
    }
  });

  fxInput.addEventListener("focus", () => hideEditor(true));

  workEl.addEventListener("scroll", () => {
    if(editBox.style.display === "block") positionEditor();
  });

  /* ====== PREFILL EXEMPLES (A + C) ====== */
  function prefillExamples(){
    // Feuil1
    activeSheet = 0;
    engineSetCell(2,1,'DUPONT');            // A2
    engineSetCell(3,1,'KURACOOL');          // A3
    engineSetCell(4,1,'REUNION');           // A4
    engineSetCell(2,2,'=GAUCHE(A2;3)');     // B2
    engineSetCell(3,2,'=DROITE(A3;2)');     // B3
    engineSetCell(4,2,'=STXT(A4;2;4)');     // B4
    engineSetCell(2,3,'=NBCAR(A2)');        // C2
    engineSetCell(3,3,'=CONCATENER("ID-";A3)'); // C3

    // Logique (SI/ET/OU)
    engineSetCell(6,1,'ABCD');              // A6
    engineSetCell(6,2,'=SI(NBCAR(A6)>3;"OK";"NON")'); // B6
    engineSetCell(7,1,'X');                 // A7
    engineSetCell(7,2,'Y');                 // B7
    engineSetCell(7,3,'=SI(ET(A7="X";B7="Y");"MATCH";"NO")'); // C7
    engineSetCell(8,3,'=SI(OU(A7="Z";B7="Y");"OUI";"NON")');  // C8

    // RECHERCHEV (VLOOKUP) + NB.SI (COUNTIF)
    engineSetCell(10,1,'Code'); engineSetCell(10,2,'Libellé');
    engineSetCell(11,1,'A');    engineSetCell(11,2,'Alpha');
    engineSetCell(12,1,'B');    engineSetCell(12,2,'Beta');
    engineSetCell(13,1,'C');    engineSetCell(13,2,'Gamma');
    engineSetCell(11,4,'B'); // D11 clé
    engineSetCell(11,5,'=RECHERCHEV(D11;A11:B13;2;FAUX)'); // E11
    engineSetCell(15,1,'A'); engineSetCell(16,1,'B'); engineSetCell(17,1,'A');
    engineSetCell(15,2,'=NB.SI(A15:A17;"A")'); // B15

    refreshAllCells();
    selected = { r:2, c:2 };
    renderAll();
  }

  /* ====== RESET ====== */
  function resetAll(){
    // Clear raw maps + engine sheet contents
    sheets.forEach(s => s.raw.clear());
    for(const sid of sheetIds){
      const empty = Array.from({length: ROWS}, () => Array.from({length: COLS}, () => null));
      hf.setSheetContent(sid, empty);
    }
    activeSheet = 0;
    selected = { r:1, c:1 };
    hideEditor(false);
    renderAll();
    setStatus("Réinitialisé.", "");
  }

  el("prefillBtn").addEventListener("click", prefillExamples);
  el("clearBtn").addEventListener("click", resetAll);

  /* ====== AUTO SCALE TO FIT IFRAME ====== */
  function scaleToFit(){
    const vw = stage.clientWidth;
    const vh = stage.clientHeight;
    const scale = Math.min(vw / 1200, vh / 675);
    canvas.style.transform = `scale(${scale})`;
  }
  window.addEventListener("resize", scaleToFit);

  /* ====== INIT ====== */
  renderAll();
  scaleToFit();
})();
</script>
</body>
</html>
