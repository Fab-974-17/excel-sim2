<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Excel-like Simulator (1200x675)</title>
  <style>
    /* ====== CANVAS FIXE GENIALLY ====== */
    :root{
      --W:1200;
      --H:675;

      /* Excel-like */
      --ui:#f3f4f6;
      --ui2:#e5e7eb;
      --line:#d1d5db;
      --text:#111827;
      --muted:#6b7280;
      --accent:#1d4ed8;

      --cellW:110px;
      --cellH:28px;
      --rowHeaderW:52px;
      --colHeaderH:26px;

      --font: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
    }

    html,body{height:100%;margin:0;background:#0000;font-family:var(--font);}

    /* Conteneur parent : centre et scale auto */
    .stage{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      background:transparent;
      overflow:hidden;
    }

    /* Canvas fixe 1200x675 */
    .canvas{
      width:calc(var(--W) * 1px);
      height:calc(var(--H) * 1px);
      background:white;
      box-shadow:0 18px 50px rgba(0,0,0,.18);
      border-radius:14px;
      overflow:hidden;
      transform-origin:center center;
    }

    /* ====== TOP BAR (pseudo-ruban) ====== */
    .topbar{
      height:54px;
      background:linear-gradient(180deg, var(--ui), #ffffff);
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      gap:12px;
      padding:8px 12px;
    }
    .badge{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:10px;
      background:#ffffff;border:1px solid var(--ui2);
      font-weight:700;color:var(--text);
    }
    .badge .dot{
      width:10px;height:10px;border-radius:999px;background:var(--accent);
      box-shadow:0 0 0 3px rgba(29,78,216,.15);
    }
    .tabsRibbon{display:flex;gap:12px;color:var(--muted);font-weight:600;font-size:13px}
    .tabsRibbon .active{color:var(--text);position:relative}
    .tabsRibbon .active:after{
      content:"";position:absolute;left:0;right:0;bottom:-10px;height:3px;border-radius:99px;background:var(--accent);
    }
    .spacer{flex:1}
    .btn{
      border:1px solid var(--ui2);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      color:var(--text);
    }
    .btn.primary{border-color:rgba(29,78,216,.35); background:rgba(29,78,216,.08); color:#0b2a7a}

    /* ====== FORMULA BAR ====== */
    .fxbar{
      height:46px;
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 12px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .nameBox{
      width:92px;
      height:34px;
      border:1px solid var(--line);
      border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      font-weight:800;
      color:#0b2a7a;
      background:#f8fafc;
      user-select:none;
    }
    .fx{
      width:30px;height:34px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid var(--line);
      background:#f8fafc;
      color:var(--muted);
      font-weight:900;
      user-select:none;
    }
    .fxInput{
      flex:1;
      height:34px;
      border:1px solid var(--line);
      border-radius:10px;
      padding:0 10px;
      outline:none;
      font-size:13px;
      color:var(--text);
      background:#fff;
    }
    .status{
      min-width:210px;
      font-size:13px;
      color:var(--muted);
      text-align:right;
      user-select:none;
    }
    .status.ok{color:#16a34a;font-weight:700}
    .status.bad{color:#dc2626;font-weight:700}

    /* ====== GRID AREA ====== */
    .sheetWrap{
      height:calc(var(--H) * 1px - 54px - 46px - 44px); /* canvas - topbar - fxbar - bottom tabs */
      background:#fff;
      position:relative;
    }

    /* Scroll zone interne (mais pas forcÃ©ment besoin si scale) */
    .work{
      position:absolute;inset:0;
      overflow:auto;
      background:#fff;
    }

    .grid{
      position:relative;
      width: calc(var(--rowHeaderW) + var(--cols) * var(--cellW));
      height: calc(var(--colHeaderH) + var(--rows) * var(--cellH));
    }

    .corner{
      position:sticky;top:0;left:0;z-index:5;
      width:var(--rowHeaderW);
      height:var(--colHeaderH);
      background:var(--ui);
      border-right:1px solid var(--line);
      border-bottom:1px solid var(--line);
    }

    .colHeader{
      position:sticky;top:0;left:var(--rowHeaderW);z-index:4;
      display:flex;
      height:var(--colHeaderH);
      background:var(--ui);
      border-bottom:1px solid var(--line);
    }
    .colHeader .h{
      width:var(--cellW);
      height:var(--colHeaderH);
      display:flex;align-items:center;justify-content:center;
      border-right:1px solid var(--line);
      font-size:12px;
      font-weight:800;
      color:#374151;
      user-select:none;
    }

    .rowHeader{
      position:sticky;left:0;top:var(--colHeaderH);z-index:3;
      width:var(--rowHeaderW);
      background:var(--ui);
      border-right:1px solid var(--line);
    }
    .rowHeader .r{
      height:var(--cellH);
      display:flex;align-items:center;justify-content:center;
      border-bottom:1px solid var(--line);
      font-size:12px;
      font-weight:800;
      color:#374151;
      user-select:none;
    }

    .cells{
      position:absolute;
      left:var(--rowHeaderW);
      top:var(--colHeaderH);
      display:grid;
      grid-template-columns: repeat(var(--cols), var(--cellW));
      grid-auto-rows: var(--cellH);
      border-top:1px solid var(--line);
      border-left:1px solid var(--line);
      background:#fff;
    }

    .cell{
      box-sizing:border-box;
      border-right:1px solid var(--line);
      border-bottom:1px solid var(--line);
      padding:5px 8px;
      font-size:13px;
      color:var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      user-select:none;
      cursor:cell;
    }

    .cell.selected{
      outline:2px solid var(--accent);
      outline-offset:-2px;
      background:rgba(29,78,216,.06);
    }

    /* Input dâ€™Ã©dition posÃ© AU-DESSUS de la cellule */
    .editBox{
      position:absolute;
      z-index:10;
      display:none;
    }
    .editInput{
      width:100%;
      height:100%;
      border:2px solid var(--accent);
      border-radius:0;
      box-sizing:border-box;
      padding:4px 7px;
      font-size:13px;
      outline:none;
      background:#fff;
      color:var(--text);
    }

    /* ====== BOTTOM SHEET TABS ====== */
    .bottomTabs{
      height:44px;
      background:var(--ui);
      border-top:1px solid var(--line);
      display:flex;
      align-items:center;
      gap:8px;
      padding:0 10px;
    }
    .sheetTab{
      cursor:pointer;
      padding:9px 12px;
      border-radius:10px;
      border:1px solid transparent;
      font-weight:800;
      font-size:13px;
      color:#374151;
      user-select:none;
    }
    .sheetTab.active{
      background:#fff;
      border-color:var(--ui2);
      color:#0b2a7a;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <div class="canvas" id="canvas">
      <div class="topbar">
        <div class="badge"><span class="dot"></span>Excel â€” Simulation</div>
        <div class="tabsRibbon">
          <div class="active">Accueil</div>
          <div>Insertion</div>
          <div>Formules</div>
          <div>DonnÃ©es</div>
        </div>
        <div class="spacer"></div>
        <button class="btn" id="clearBtn">RÃ©initialiser</button>
        <button class="btn primary" id="exerciseBtn">Mode exercice</button>
      </div>

      <div class="fxbar">
        <div class="nameBox" id="nameBox">A1</div>
        <div class="fx">fx</div>
        <input class="fxInput" id="fxInput" placeholder="Barre de formule (tape ici ou directement dans une cellule)" />
        <div class="status" id="status">Clique une cellule puis tape.</div>
      </div>

      <div class="sheetWrap">
        <div class="work" id="work">
          <div class="grid" id="grid">
            <div class="corner"></div>
            <div class="colHeader" id="colHeader"></div>
            <div class="rowHeader" id="rowHeader"></div>
            <div class="cells" id="cells"></div>

            <!-- overlay input -->
            <div class="editBox" id="editBox">
              <input class="editInput" id="editInput" />
            </div>
          </div>
        </div>
      </div>

      <div class="bottomTabs" id="tabs"></div>
    </div>
  </div>

<script>
(() => {
  /* ====== CONFIG ====== */
  const ROWS = 24;
  const COLS = 14;

  const sheets = [
    { name: "Feuil1", data: new Map() },
    { name: "Exercices", data: new Map() },
    { name: "RÃ©sultats", data: new Map() },
  ];

  // Dimensions CSS (doivent matcher :root)
  const cellW = 110, cellH = 28, rowHeaderW = 52, colHeaderH = 26;

  let activeSheet = 0;
  let selected = { r: 1, c: 1 };
  let exerciseMode = false;
  let stepIndex = 0;

  /* ====== DOM ====== */
  const el = (id) => document.getElementById(id);
  const canvas = el("canvas");
  const stage  = el("stage");
  const gridEl = el("grid");
  const workEl = el("work");
  const colHeaderEl = el("colHeader");
  const rowHeaderEl = el("rowHeader");
  const cellsEl = el("cells");
  const tabsEl = el("tabs");
  const nameBox = el("nameBox");
  const fxInput = el("fxInput");
  const status = el("status");
  const editBox = el("editBox");
  const editInput = el("editInput");

  gridEl.style.setProperty("--rows", ROWS);
  gridEl.style.setProperty("--cols", COLS);

  /* ====== UTILS ====== */
  const colName = (n) => {
    let s = "";
    while (n > 0) {
      const m = (n - 1) % 26;
      s = String.fromCharCode(65 + m) + s;
      n = Math.floor((n - 1) / 26);
    }
    return s;
  };
  const addr = (r, c) => `${colName(c)}${r}`;
  const key  = (r, c) => `${r},${c}`;

  function getCellValue(r,c){
    return sheets[activeSheet].data.get(key(r,c)) ?? "";
  }
  function setCellValue(r,c,v){
    const val = (v ?? "");
    if(val === "") sheets[activeSheet].data.delete(key(r,c));
    else sheets[activeSheet].data.set(key(r,c), val);
  }

  function setStatus(text, type=""){
    status.textContent = text || "";
    status.className = "status" + (type ? " " + type : "");
  }

  /* ====== RENDER ====== */
  function renderHeaders(){
    colHeaderEl.innerHTML = "";
    for(let c=1;c<=COLS;c++){
      const d=document.createElement("div");
      d.className="h";
      d.textContent=colName(c);
      colHeaderEl.appendChild(d);
    }
    rowHeaderEl.innerHTML = "";
    for(let r=1;r<=ROWS;r++){
      const d=document.createElement("div");
      d.className="r";
      d.textContent=r;
      rowHeaderEl.appendChild(d);
    }
  }

  function renderTabs(){
    tabsEl.innerHTML = "";
    sheets.forEach((s, i) => {
      const t = document.createElement("div");
      t.className = "sheetTab" + (i===activeSheet ? " active" : "");
      t.textContent = s.name;
      t.onclick = () => { activeSheet=i; hideEditor(true); renderAll(); };
      tabsEl.appendChild(t);
    });
  }

  function renderCells(){
    cellsEl.innerHTML = "";
    for(let r=1;r<=ROWS;r++){
      for(let c=1;c<=COLS;c++){
        const d = document.createElement("div");
        d.className = "cell";
        d.textContent = getCellValue(r,c);
        d.dataset.r = r;
        d.dataset.c = c;
        d.addEventListener("mousedown", (e) => {
          e.preventDefault();
          select(r,c);
        });
        d.addEventListener("dblclick", () => beginEdit(r,c));
        cellsEl.appendChild(d);
      }
    }
  }

  function updateSelectionUI(){
    const nodes = cellsEl.querySelectorAll(".cell");
    nodes.forEach(n => n.classList.remove("selected"));
    const idx = (selected.r-1)*COLS + (selected.c-1);
    const node = nodes[idx];
    if(node) node.classList.add("selected");

    nameBox.textContent = addr(selected.r, selected.c);
    fxInput.value = getCellValue(selected.r, selected.c);
  }

  function renderAll(){
    renderTabs();
    renderHeaders();
    renderCells();
    updateSelectionUI();
    ensureSelectionVisible();
    updateExerciseHint();
  }

  /* ====== SELECTION + VISIBILITY ====== */
  function select(r,c){
    hideEditor(true);
    selected = { r, c };
    updateSelectionUI();
    setStatus("Tape pour saisir. EntrÃ©e valide, Ã‰chap annule.", "");
  }

  function ensureSelectionVisible(){
    // Scroll grid so selected is visible
    const x = rowHeaderW + (selected.c-1)*cellW;
    const y = colHeaderH + (selected.r-1)*cellH;
    const pad = 16;

    const viewL = workEl.scrollLeft;
    const viewT = workEl.scrollTop;
    const viewR = viewL + workEl.clientWidth;
    const viewB = viewT + workEl.clientHeight;

    const cellR = x + cellW;
    const cellB = y + cellH;

    if(x - pad < viewL) workEl.scrollLeft = Math.max(0, x - pad);
    else if(cellR + pad > viewR) workEl.scrollLeft = cellR + pad - workEl.clientWidth;

    if(y - pad < viewT) workEl.scrollTop = Math.max(0, y - pad);
    else if(cellB + pad > viewB) workEl.scrollTop = cellB + pad - workEl.clientHeight;
  }

  /* ====== EDITION DIRECTE DANS CELLULE ====== */
  function beginEdit(r=selected.r, c=selected.c){
    selected = { r, c };
    updateSelectionUI();
    positionEditor();
    editInput.value = getCellValue(r,c);
    editBox.style.display = "block";
    editInput.focus();
    editInput.select();
  }

  function positionEditor(){
    // Position relative to grid
    const left = rowHeaderW + (selected.c-1)*cellW;
    const top  = colHeaderH + (selected.r-1)*cellH;

    editBox.style.left = left + "px";
    editBox.style.top  = top  + "px";
    editBox.style.width  = cellW + "px";
    editBox.style.height = cellH + "px";
  }

  function hideEditor(commit){
    if(editBox.style.display !== "block") return;
    if(commit){
      const v = editInput.value ?? "";
      setCellValue(selected.r, selected.c, v);
      // update cell text
      const idx = (selected.r-1)*COLS + (selected.c-1);
      const node = cellsEl.querySelectorAll(".cell")[idx];
      if(node) node.textContent = v;
      fxInput.value = v;
      if(exerciseMode) checkExercise(v);
      else setStatus("EnregistrÃ© âœ…", "ok");
    } else {
      setStatus("AnnulÃ©", "");
    }
    editBox.style.display = "none";
  }

  // Typing should start editing immediately (like Excel)
  window.addEventListener("keydown", (e) => {
    // If focus is in an input, ignore global handlers except special keys
    const inInput = document.activeElement === fxInput || document.activeElement === editInput;
    if(inInput) return;

    if(e.key === "Enter"){ e.preventDefault(); beginEdit(); return; }

    if(e.key.startsWith("Arrow")){
      e.preventDefault();
      const {r,c} = selected;
      if(e.key==="ArrowUp")    select(Math.max(1,r-1), c);
      if(e.key==="ArrowDown")  select(Math.min(ROWS,r+1), c);
      if(e.key==="ArrowLeft")  select(r, Math.max(1,c-1));
      if(e.key==="ArrowRight") select(r, Math.min(COLS,c+1));
      return;
    }

    // If user presses a printable character, start editing and put char
    if(e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey){
      beginEdit();
      editInput.value = e.key;
      // place caret at end
      requestAnimationFrame(() => {
        editInput.setSelectionRange(editInput.value.length, editInput.value.length);
      });
    }
  });

  // Edit input keys
  editInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){ e.preventDefault(); hideEditor(true); }
    if(e.key === "Escape"){ e.preventDefault(); hideEditor(false); }
  });

  // Click outside commits
  document.addEventListener("mousedown", (e) => {
    if(editBox.style.display !== "block") return;
    const within = editBox.contains(e.target);
    if(!within){
      hideEditor(true);
    }
  });

  // Formula bar edits current cell
  fxInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      setCellValue(selected.r, selected.c, fxInput.value ?? "");
      const idx = (selected.r-1)*COLS + (selected.c-1);
      const node = cellsEl.querySelectorAll(".cell")[idx];
      if(node) node.textContent = fxInput.value ?? "";
      if(exerciseMode) checkExercise(fxInput.value ?? "");
      else setStatus("EnregistrÃ© âœ…", "ok");
      fxInput.blur();
    }
    if(e.key === "Escape"){
      e.preventDefault();
      fxInput.value = getCellValue(selected.r, selected.c);
      setStatus("AnnulÃ©", "");
      fxInput.blur();
    }
  });

  fxInput.addEventListener("focus", () => hideEditor(true));

  // Reposition editor on scroll (if open)
  workEl.addEventListener("scroll", () => {
    if(editBox.style.display === "block") positionEditor();
  });

  /* ====== EXERCISE MODE (optionnel) ====== */
  const exerciseSteps = [
    { sheet: "Exercices", target:{r:2,c:2}, expect:"=GAUCHE(A2;3)", msg:"Dans B2, saisis =GAUCHE(A2;3)" },
    { sheet: "Exercices", target:{r:3,c:2}, expect:"=DROITE(A3;2)",  msg:"Dans B3, saisis =DROITE(A3;2)" },
    { sheet: "Exercices", target:{r:4,c:2}, expect:"=STXT(A4;2;4)",  msg:"Dans B4, saisis =STXT(A4;2;4)" },
  ];

  function updateExerciseHint(){
    if(!exerciseMode){
      setStatus("Clique une cellule puis tape.", "");
      return;
    }
    const step = exerciseSteps[stepIndex];
    setStatus(`ðŸŽ¯ Exercice ${stepIndex+1}/${exerciseSteps.length} â€” ${step.msg}`, "");
  }

  function checkExercise(v){
    const step = exerciseSteps[stepIndex];
    if(sheets[activeSheet].name !== step.sheet){
      setStatus(`Va sur l'onglet "${step.sheet}"`, "bad");
      return;
    }
    if(selected.r !== step.target.r || selected.c !== step.target.c){
      setStatus(`Clique ${addr(step.target.r, step.target.c)} d'abord`, "bad");
      return;
    }
    if((v||"").trim().toUpperCase() === step.expect.trim().toUpperCase()){
      setStatus("âœ… Correct !", "ok");
      if(stepIndex < exerciseSteps.length-1) stepIndex++;
      updateExerciseHint();
    } else {
      setStatus("âŒ Pas encore. VÃ©rifie la formule.", "bad");
    }
  }

  function toggleExercise(){
    exerciseMode = !exerciseMode;
    stepIndex = 0;

    // Prefill sample data in "Exercices"
    const exIdx = sheets.findIndex(s => s.name === "Exercices");
    if(exIdx >= 0){
      sheets[exIdx].data.set(key(2,1), "DUPONT");
      sheets[exIdx].data.set(key(3,1), "KURACOOL");
      sheets[exIdx].data.set(key(4,1), "REUNION");
    }

    setStatus(exerciseMode ? "Mode exercice activÃ©" : "Mode libre", exerciseMode ? "ok" : "");
    renderAll();

    // Auto-switch to "Exercices" when enabling
    if(exerciseMode && exIdx >= 0){
      activeSheet = exIdx;
      selected = { r:2, c:2 };
      renderAll();
    }
  }

  /* ====== RESET ====== */
  function resetAll(){
    sheets.forEach(s => s.data.clear());
    activeSheet = 0;
    selected = { r:1, c:1 };
    exerciseMode = false;
    stepIndex = 0;
    hideEditor(false);
    renderAll();
    setStatus("RÃ©initialisÃ©.", "");
  }

  el("exerciseBtn").addEventListener("click", toggleExercise);
  el("clearBtn").addEventListener("click", resetAll);

  /* ====== AUTO SCALE TO FIT IFRAME ====== */
  function scaleToFit(){
    // stage = viewport iframe, canvas fixed 1200x675
    const vw = stage.clientWidth;
    const vh = stage.clientHeight;

    const scale = Math.min(vw / 1200, vh / 675);
    canvas.style.transform = `scale(${scale})`;
  }
  window.addEventListener("resize", scaleToFit);

  /* ====== INIT ====== */
  renderAll();
  scaleToFit();
})();
</script>
</body>
</html>
